<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>Where's the fucking train?</title>
	<link rel="stylesheet" type="text/css" href="/dist/styles.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="apple-mobile-web-app-capable" content="yes">

	<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
	<meta name="apple-mobile-web-app-title" content="WTF Train">
	<link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
	<link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
	<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
	<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
	<meta name="msapplication-TileColor" content="#ffc40d">
	<meta name="msapplication-TileImage" content="/mstile-144x144.png">
	<meta name="application-name" content="WTF Train">

	<meta property="og:title" content="Where's the fucking train?" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="http://wheresthefuckingtrain.com" />
	<meta property="og:image" content="http://wheresthefuckingtrain.com/logo-300.png" />
	<meta property="og:description" content="Real-time train arrival times for the NYC subway, so you can know where the fucking train is." />
	
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-XP4ZMG8FBN"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-XP4ZMG8FBN');
	</script>
</head>
<body>
	<div id="throbber">
		<div class="logo-150">
			Loading...
		</div>
	</div>

	<div id="menu">
		<section>
			<span class="close close-button" onclick="history.go(-1);">&times;</span>
			<h2 class="close">Where's the fucking train?</h2>
			<div class="menu-item geolocate-only"><a href="#current-location">Go to current location</a></div>
			<div class="menu-item"><a href="#">See favorite stations</a></div>
			<div class="train-lines">
				<a href="#/r/1" class="mta-bullet line-1">1</a>
				<a href="#/r/2" class="mta-bullet line-2">2</a>
				<a href="#/r/3" class="mta-bullet line-3">3</a><br />
				<a href="#/r/4" class="mta-bullet line-4">4</a>
				<a href="#/r/5" class="mta-bullet line-5">5</a>
				<a href="#/r/6" class="mta-bullet line-6">6</a>
				<a href="#/r/7" class="mta-bullet line-7">7</a><br />
				<a href="#/r/A" class="mta-bullet line-A">A</a>
				<a href="#/r/C" class="mta-bullet line-C">C</a>
				<a href="#/r/E" class="mta-bullet line-E">E</a><br />
				<a href="#/r/N" class="mta-bullet line-N">N</a>
				<a href="#/r/Q" class="mta-bullet line-Q">Q</a>
				<a href="#/r/R" class="mta-bullet line-R">R</a>
				<a href="#/r/W" class="mta-bullet line-W">W</a><br />
				<a href="#/r/B" class="mta-bullet line-B">B</a>
				<a href="#/r/D" class="mta-bullet line-D">D</a>
				<a href="#/r/F" class="mta-bullet line-F">F</a>
				<a href="#/r/M" class="mta-bullet line-M">M</a><br />
				<a href="#/r/L" class="mta-bullet line-L">L</a>
				<a href="#/r/G" class="mta-bullet line-G">G</a>
				<a href="#/r/J" class="mta-bullet line-J">J</a>
				<a href="#/r/Z" class="mta-bullet line-Z">Z</a>
			</div>

			<h3>How do I edit my favorite stations?</h3>
			<p>Tap on a station name to see options to add or remove it from your favorites.</p>

			<h3>Source Code</h3>
			<p>WTFT is open source and available on <a href="https://github.com/jonthornton/WTFT">GitHub</a>. It's designed to pull data from <a href="https://github.com/jonthornton/MTAPI">MTAPI</a>.</p>
		</section>

		<div class="logo-150"></div>

		<div class="footer">
			&copy; 2018 <a href="http://www.jonthornton.com">Jon Thornton</a> &hearts; NYC
		</div>
	</div>

	<div id="trains">
		<section>
			<div id="last-updated-container">Updated <time id="last-updated">never</time></div>
			<a id="header-logo" href="#menu"></a>
			<div id="first-use-help">
				<div>Tap the WTFT logo in the top right to see more stations.</div>

				<div>Tap a station name to see other options.</div>

				<div class="legend">
					<h3>Legend</h3>
					<span class="uptown">
						<span class="direction-icon">&#9650;</span> Uptown / Manhattan
					</span>
					<span class="downtown">
						<span class="direction-icon">&#9660;</span> Downtown / Brooklyn
					</span>
				</div>
			</div>
			<div class="error" id="status"></div>
			<div class="error" id="error-buttons">
				<span class="button" id="try-again" onclick="window.location.reload()">Try again</span>
				<a class="button" href="#menu">Menu</a>
			</div>
			<div id="live-stations"></div>
			<div class="legend">
				<h3>Legend</h3>
				<div>
					<span class="uptown">
						<span class="direction-icon">&#9650;</span> Uptown / Manhattan
					</span>
					<span class="downtown">
						<span class="direction-icon">&#9660;</span> Downtown / Brooklyn
					</span>
				</div>
				<div class="explanation current-location">
					Showing nearby stations &ndash; <a href="#" id="permalink">permalink</a>. Use the <a href="#menu" id="permalink">menu</a> to see more stations.
				</div>

				<div class="explanation favorites">
					Showing favorite stations. Use the <a href="#menu" id="permalink">menu</a> to edit favorites.
				</div>
			</div>

			<div class="footer">
				&copy; 2018 <a href="http://www.jonthornton.com">Jon Thornton</a> &hearts; NYC
			</div>
		</section>
	</div>


	<script src="settings.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
	<script src="dist/fastclick.min.js"></script>
	<script>
		$(function() {
		    FastClick.attach(document.body);
		});
	</script>

	<script id="station-template" type="text/x-handlebars-template">
		<div class="station" data-station-id="{{id}}">
			<h2><a href="/#/l/{{coords location}}">{{name}}</a></h2>
			<div class="actions">
				<a class="map-link" href="{{mapLink location}}" target=_blank>map</a>
				<a href="/#/l/{{coords location}}">permalink</a>
				<span class="a fav-button add">add to favorites</span>
				<span class="a fav-button remove">remove from favorites</span>
			</div>
			{{#if last_update}}
				<div class="uptown">
					{{#each N}}
						<div class="train">
							<span class="direction-icon">&#9650;</span>
							<span class="mta-bullet line-{{routeFilter route}}">{{routeFilter route}}</span>
							<time datetime="{{time}}"></time>
						</div>
					{{/each}}
				</div>
				<div class="downtown">
					{{#each S}}
						<div class="train">
							<span class="direction-icon">&#9660;</span>
							<span class="mta-bullet line-{{routeFilter route}}">{{routeFilter route}}</span>
							<time datetime="{{time}}"></time>
						</div>
					{{/each}}
				</div>
				<div class="clearfix"></div>
			{{else}}
				<div class="no-data">No data available</div>
			{{/if}}
		</div>
	</script>

	<script>
	// don't pollute the global namespace!
	(function(){
		var DEFAULT_STATIONS = [
			"82bd",	// union square
			"84ac",	// times square
			"d2c6",	// barclays center
			"3cf6",	// fulton street
		];

		var stationSource = $("#station-template").html();
		var stationTemplate = Handlebars.compile(stationSource);

		Handlebars.registerHelper('coords', function(location) {
			return (+location[0].toFixed(6)) + "," + (+location[1].toFixed(6));
		});

		var mapBase;
		if ((navigator.userAgent.match(/iPhone/i)) || (navigator.userAgent.match(/iPad/i))) {
			mapBase = 'http://maps.apple.com?q=';
		} else {
			mapBase = 'https://maps.google.com?q=';
		}

		Handlebars.registerHelper('mapLink', function(location) {
			return mapBase + (+location[0].toFixed(6)) + ',' + (+location[1].toFixed(6));
		});

		Handlebars.registerHelper('routeFilter', function(route_id) {
			return route_id.charAt(0);
		});

		var refreshTimer, ajaxHandle, gUserPosition;
		function route()
		{
			// start with a clean slate
			window.scrollTo(0, 0);
			clearTimeout(refreshTimer);
			$('.error').hide();
			$('.explanation').hide();
			$('#trains').show();
			$('#menu').hide();
			if (ajaxHandle) {
				ajaxHandle.abort();
				ajaxHandle = null;
			}

			if (localStorage.getItem('seenMenu')) {
				$('#first-use-help').hide();
			} else {
				$('#first-use-help').show();
			}

			switch (window.location.hash) {
				case '#menu':
					$('#menu').slideDown(150);
					$('#trains').hide();
					hideThrobber();
					localStorage.setItem('seenMenu', true);
					return;

				case '#current-location':
					// use GPS
					showThrobber();
					gotoGPSLocation();
					return;
			}

			var coords = window.location.hash.match(/#\/l\/((-)?\d+\.\d+),((-)?\d+\.\d+)/);
			if (coords) {
				// lat/lon from URL
				loadTrainData(1*coords[1], 1*coords[3]);
			} else if (window.location.hash.charAt(2) == 'r') {
				// train route id
				loadTrainData(window.location.hash.charAt(4));
			} else {
				// favorite stations
				loadTrainData();
				$('.explanation.favorites').show();
			}
		}

		$(window).on('hashchange', route);
		route();

		if (!('geolocation' in navigator)) {
			$('.geolocate-only').hide();
		}

		refreshRelativeTimes()
		setInterval(refreshRelativeTimes, 10000);

		$('#live-stations').on('click', '.fav-button.add', function(e){
			var $station = $(this).closest('.station');
			$station.find('.fav-button').toggle();
			addFavoriteStation($station.data('stationId'));
			alert($station.find('h2 a').text()+' has been added to your favorites.');
		});

		$('#live-stations').on('click', '.fav-button.remove', function(e){
			var $station = $(this).closest('.station');
			$station.find('.fav-button').toggle();
			removeFavoriteStation($station.data('stationId'));
			alert($station.find('h2 a').text()+' has been removed from your favorites.');
		});

		$('#live-stations').on('click', '.station h2 a', function(e){
			$(this).closest('.station').find('.actions').toggle(100);
			e.preventDefault();
		});

		function getFavoriteStations()
		{
			var favs = localStorage.getItem('favoriteStations');
			if (favs) {
				favs = favs.split(',')

				// check for old-style favorites
				if (favs[0] && String(favs[0]*1) === favs[0]) {
					favs = null;
				}
			}

			if (favs) {
				return favs;
			} else {
				// initialize defaults
				localStorage.setItem('favoriteStations', DEFAULT_STATIONS.join(','));
				return DEFAULT_STATIONS;
			}
		}

		function addFavoriteStation(id)
		{
			var favorites = getFavoriteStations() || [];
			favorites.unshift(id);
			localStorage.setItem('favoriteStations', favorites.join(','));
		}

		function removeFavoriteStation(id)
		{
			var favs = getFavoriteStations() || [];
			var index = favs.indexOf(id);
			if (index > -1) {
			    favs.splice(index, 1);
			}
			localStorage.setItem('favoriteStations', favs.join(','));
		}

		function gotoGPSLocation()
		{
			if ("geolocation" in navigator) {
				var geolocate = {
					success: function(position) {
						clearTimeout(errorTimer);
						gUserPosition = [position.coords.latitude, position.coords.longitude];
						$('.explanation.current-location').show();
						loadTrainData(position.coords.latitude, position.coords.longitude);
					},
					error: function(){
						// error!
						clearTimeout(errorTimer);
						alert('WTFT couldn\'t find your current location. Pick a station from the list.');
						replaceState('menu');
						route();
					},
					options: {
						enableHighAccuracy: false,
						timeout: 10000,
						maximumAge: 600000
					}
				}
				var errorTimer = setTimeout(geolocate.error, 20000);

				navigator.geolocation.getCurrentPosition(geolocate.success, geolocate.error, geolocate.options);
			} else {
				replaceState('menu');
				route();
			}
		}

		function showThrobber()
		{
			$('#throbber').slideDown(150);
		}

		function hideThrobber()
		{
			$('#throbber').slideUp(150);
		}

		function ajaxErrorHandler(resp)
		{
			// resp.status always seems to be 0...
			switch(resp.status) {
				case 404:
					replaceState('menu');
					route();
					break;

				case 500:
				case 0:
					$('#status').text('There was a problem communicating with the server.');
					$('.error').show();
			}

			clearTimeout(refreshTimer);
			hideThrobber();
		}

		function loadTrainData(lat, lon, noThrobber)
		{
			if (!noThrobber) {
				showThrobber();
			}

			var endpoint, permalink;
			if (lat && lon) {
				// lat/lon
				endpoint = API_URL+'/by-location?lat='+lat+'&lon='+lon;
				permalink = '#/l/'+lat+','+lon;
				if (window.location.hash != permalink) {
					$('#permalink').prop('href', permalink);
				}
			} else if (lat) {
				// train line
				endpoint = API_URL+'/by-route/'+lat;
			} else {
				// saved/default favorites
				var ids = getFavoriteStations();
				endpoint = API_URL+'/by-id/'+ids.join(',');
			}

			ajaxHandle = $.getJSON(endpoint)
				.done(function(resp){
					hydrateStations(resp.data, resp.updated);
				})
				.fail(ajaxErrorHandler);

			refreshTimer = setTimeout(function(){
				loadTrainData(lat, lon, true);
			}, REFRESH_INTERVAL);
		}

		function hydrateStations(data, updated)
		{
			if (new Date().getTime() - new Date(updated).getTime() > 300000) {
				// stale data from MTA feed
				$('#status').text('The MTA isn\'t providing accurate train data right now :(');
				$('#status').show();
			} else {
				$('.error').hide();
			}

			$('#last-updated').attr('datetime', updated);

			$('#live-stations .station').remove();
			var container = $('#live-stations');

			for (var i in data) {
				var html = stationTemplate(data[i]);
				container.append(html);
			}

			// display add/remove favorites buttons
			var favs = getFavoriteStations();
			$('.station').each(function(i, el) {
				var $el = $(el);
				if (favs.indexOf($el.data('stationId')) == -1) {
					$el.find('.fav-button.remove').hide();
				} else {
					$el.find('.fav-button.add').hide();
				}
			});

			refreshRelativeTimes();
			hideThrobber();
		}

		function replaceState(url) {
			if (!("replaceState" in history)) {
				return;
			}

			url = '/#'+url;
			if (window.location.hash.length > 0) {
				history.pushState({}, null, url);
			} else {
				history.replaceState({}, null, url);
			}
		}

		function refreshRelativeTimes() {
			var now = Date.now()
			$('time[datetime]').each(function(){
				$this = $(this);
				var trainTime = new Date($this.attr('datetime'));
				var minutesDiff = Math.ceil((trainTime.getTime() - now) / 60000);

				if (minutesDiff == 0) {
					$this.text('Now');
				} else if (minutesDiff < 0) {
					$this.text(Math.abs(minutesDiff) + ' min ago');
				} else {
					$this.text(minutesDiff + ' min');
				}
			});
		}
	})();
	</script>
</body>
</html>
